<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Neo4j NL→CQL→ECharts</title>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'PingFang SC', 'Microsoft YaHei', sans-serif; margin: 0; }
      header { padding: 12px 16px; background: #111; color: #fff; }
      .toolbar { display: flex; gap: 8px; padding: 12px 16px; align-items: center; }
      .toolbar input { flex: 1; padding: 8px 10px; }
      .toolbar button { padding: 8px 12px; }
      .main { display: grid; grid-template-columns: 420px 1fr; gap: 8px; padding: 8px; height: calc(100vh - 92px); box-sizing: border-box; }
      .left { display: flex; flex-direction: column; gap: 8px; }
      .panel { border: 1px solid #e5e5e5; border-radius: 6px; padding: 8px; overflow: auto; height: 100%; }
      .panel pre { white-space: pre-wrap; word-break: break-word; }
      #chart { width: 100%; height: 100%; border: 1px solid #e5e5e5; border-radius: 6px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  </head>
  <body>
    <header>Neo4j 自然语言查询（最小可执行）</header>
    <div class="toolbar">
      <input id="q" placeholder="输入自然语言查询，如：查找 Alice 的同事" />
      <button id="btn-nlq">生成并执行</button>
      <button id="btn-run">执行 CQL</button>
    </div>
    <div class="main">
      <div class="left">
        <div class="panel" style="height: 40%">
          <div><strong>CQL</strong></div>
          <textarea id="cql" style="width: 100%; height: calc(100% - 24px);"></textarea>
        </div>
        <div class="panel" style="height: 60%">
          <div><strong>结果</strong></div>
          <pre id="result"></pre>
        </div>
      </div>
      <div id="chart"></div>
    </div>

    <script>
      const chart = echarts.init(document.getElementById('chart'));
      const q = document.getElementById('q');
      const cqlEl = document.getElementById('cql');
      const resultEl = document.getElementById('result');

      function renderGraph(graph) {
        chart.setOption({
          tooltip: {},
          legend: [{ data: [] }],
          series: [{
            type: 'graph',
            layout: 'force',
            roam: true,
            data: graph.nodes,
            links: graph.links,
            categories: [],
            label: { show: true, position: 'right' },
            force: { repulsion: 100, edgeLength: 80 },
            lineStyle: { color: '#999' }
          }]
        });
      }

      async function callNlq() {
        const resp = await fetch('/nlq', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: q.value, options: { limit: 100 } })
        });
        const data = await resp.json();
        if (!resp.ok) {
          resultEl.textContent = JSON.stringify(data, null, 2);
          return;
        }
        cqlEl.value = data.cql;
        resultEl.textContent = JSON.stringify(data.graph.meta, null, 2);
        renderGraph(data.graph);
      }

      async function runCql() {
        const cql = cqlEl.value;
        const resp = await fetch('/run-cql', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cql, params: {} })
        });
        const data = await resp.json();
        if (!resp.ok) {
          resultEl.textContent = JSON.stringify(data, null, 2);
          return;
        }
        resultEl.textContent = JSON.stringify(data.graph.meta, null, 2);
        renderGraph(data.graph);
      }

      document.getElementById('btn-nlq').addEventListener('click', callNlq);
      document.getElementById('btn-run').addEventListener('click', runCql);
      window.addEventListener('resize', () => chart.resize());
    </script>
  </body>
  </html>


