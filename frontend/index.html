<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Neo4j NLâ†’CQLâ†’ECharts</title>
    <style>
      :root {
        --bg: #f7f8fa;
        --text: #111;
        --muted: #656f7b;
        --panel: #ffffff;
        --border: #e5e7eb;
        --primary: #2b7fff;
        --primary-600: #1f5fcc;
        --ring: rgba(43, 127, 255, .25);
        --chip-bg: #eef4ff;
        --chip-text: #1f4b99;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #0b0f17;
          --text: #e6e6e6;
          --muted: #9aa4b2;
          --panel: #0f1623;
          --border: #1f2a3b;
          --chip-bg: #14203a;
          --chip-text: #b7c6ff;
        }
      }
      body.dark {
        --bg: #0b0f17;
        --text: #e6e6e6;
        --muted: #9aa4b2;
        --panel: #0f1623;
        --border: #1f2a3b;
        --chip-bg: #14203a;
        --chip-text: #b7c6ff;
      }
      * { box-sizing: border-box; }
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'PingFang SC', 'Microsoft YaHei', sans-serif; margin: 0; background: var(--bg); color: var(--text); }
      header { position: sticky; top: 0; z-index: 10; display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 12px 16px; background: var(--panel); color: var(--text); border-bottom: 1px solid var(--border); }
      header .brand { display: flex; flex-direction: column; line-height: 1.1; }
      header .brand .title { font-weight: 700; letter-spacing: .1px; }
      header .brand .subtitle { font-size: 12px; color: var(--muted); }
      header .actions { display: flex; gap: 8px; }
      .icon-btn { appearance: none; border: 1px solid var(--border); background: var(--panel); color: var(--text); padding: 6px 10px; border-radius: 8px; cursor: pointer; line-height: 1; }
      .icon-btn:hover { border-color: #c8d1e0; }
      .icon-btn:focus-visible { outline: 2px solid var(--ring); outline-offset: 2px; }

      .toolbar { display: flex; gap: 8px; padding: 12px 16px; align-items: center; backdrop-filter: saturate(150%); }
      .toolbar input { flex: 1; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--panel); color: var(--text); }
      .toolbar input::placeholder { color: var(--muted); }
      .toolbar button { padding: 10px 14px; border-radius: 10px; border: 1px solid var(--primary); background: var(--primary); color: #fff; cursor: pointer; }
      .toolbar button.secondary { background: transparent; color: var(--primary); }
      .toolbar button:disabled { opacity: .6; cursor: not-allowed; }
      .loading { position: relative; pointer-events: none; }
      .loading::after { content: ""; position: absolute; right: 10px; top: 50%; width: 14px; height: 14px; margin-top: -7px; border: 2px solid rgba(255,255,255,.6); border-top-color: transparent; border-radius: 50%; animation: spin .9s linear infinite; }
      .toolbar button.secondary.loading::after { border-color: var(--primary); border-top-color: transparent; }
      @keyframes spin { to { transform: rotate(360deg); } }

      .examples { display: flex; gap: 8px; padding: 0 16px 12px 16px; flex-wrap: wrap; }
      .chip { border: 1px solid transparent; background: var(--chip-bg); color: var(--chip-text); padding: 6px 10px; border-radius: 999px; cursor: pointer; }
      .chip:hover { filter: brightness(1.05); }

      .main { display: grid; grid-template-columns: 420px 1fr; gap: 8px; padding: 8px; height: calc(100vh - 120px); box-sizing: border-box; }
      @media (max-width: 920px) { .main { grid-template-columns: 1fr; height: auto; } #chart { height: 420px; } }
      .left { display: flex; flex-direction: column; gap: 8px; }
      .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 10px; overflow: auto; height: 100%; box-shadow: 0 1px 0 rgba(17,24,39,.03); }
      .panel pre { white-space: pre-wrap; word-break: break-word; color: var(--muted); }
      .panel strong { color: var(--text); }
      textarea { width: 100%; height: calc(100% - 24px); resize: vertical; background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; }
      textarea:focus-visible, .toolbar input:focus-visible { outline: 2px solid var(--ring); outline-offset: 2px; }
      #chart { width: 100%; height: 100%; border: 1px solid var(--border); border-radius: 10px; background: var(--panel); }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  </head>
  <body>
    <header>
      <div class="brand">
        <div class="title">Neo4j è‡ªç„¶è¯­è¨€æŸ¥è¯¢</div>
        <div class="subtitle">NL â†’ CQL â†’ ECharts</div>
      </div>
      <div class="actions">
        <button id="btn-theme" class="icon-btn" aria-pressed="false" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
      </div>
    </header>
    <div class="toolbar">
      <input id="q" placeholder="è¾“å…¥è‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼Œå¦‚ï¼šæ‰€æœ‰çš„å­¤å„¿èŠ‚ç‚¹ï¼ˆé™åˆ¶20æ¡ï¼‰" />
      <button id="btn-nlq">ç”Ÿæˆå¹¶æ‰§è¡Œ</button>
      <button id="btn-run" class="secondary">æ‰§è¡Œ CQL</button>
    </div>
    <div class="examples">
      <button class="chip" data-q="æ‰€æœ‰çš„å­¤å„¿èŠ‚ç‚¹ï¼ˆé™åˆ¶20æ¡ï¼‰">æ‰€æœ‰çš„å­¤å„¿èŠ‚ç‚¹ï¼ˆé™åˆ¶20æ¡ï¼‰</button>
      <button class="chip" data-q="åˆæˆé…æ–¹çš„åŸæ–™å’Œææ–™ï¼ˆé™åˆ¶20æ¡ï¼‰">åˆæˆé…æ–¹çš„åŸæ–™å’Œææ–™ï¼ˆé™åˆ¶20æ¡ï¼‰</button>
      <button class="chip" data-q="IDä¸º404çš„blockçš„æ‰è½ç‰©ï¼ˆDROPSå…³ç³»ï¼‰">IDä¸º404çš„blockçš„æ‰è½ç‰©ï¼ˆDROPSå…³ç³»ï¼‰</button>
      <button class="chip" data-q="æœ€è¿‘æ–°å¢çš„ 10 ä¸ªèŠ‚ç‚¹">æœ€è¿‘æ–°å¢çš„ 10 ä¸ªèŠ‚ç‚¹</button>
    </div>
    <div class="main">
      <div class="left">
        <div class="panel" style="height: 40%">
          <div><strong>CQL</strong></div>
          <textarea id="cql" style="width: 100%; height: calc(100% - 24px);"></textarea>
        </div>
        <div class="panel" style="height: 28%">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
            <strong>Params (JSON)</strong>
          </div>
          <textarea id="params" style="width: 100%; height: calc(100% - 28px);"></textarea>
        </div>
        <div class="panel" style="height: 32%">
          <div style="display:flex;align-items:center;gap:8px;">
            <strong>ç»“æœ</strong>
            <div role="tablist" aria-label="ç»“æœè§†å›¾" style="display:flex;gap:6px;margin-left:8px;">
              <button id="tab-text" class="icon-btn" role="tab" aria-selected="true">æ–‡æœ¬</button>
              <button id="tab-json" class="icon-btn" role="tab" aria-selected="false">JSON</button>
              <button id="tab-table" class="icon-btn" role="tab" aria-selected="false">è¡¨æ ¼</button>
            </div>
          </div>
          <pre id="text-out" style="display:block; white-space:pre-wrap; word-break:break-word;"></pre>
          <pre id="json-out" style="display:none; white-space:pre-wrap; word-break:break-word;"></pre>
          <div id="table-out" style="display:none; overflow:auto;"></div>
        </div>
      </div>
      <div id="chart"></div>
    </div>

    <script>
      const chartEl = document.getElementById('chart');
      let chart = echarts.init(chartEl);
      const q = document.getElementById('q');
      const cqlEl = document.getElementById('cql');
      const textOut = document.getElementById('text-out');
      const jsonOut = document.getElementById('json-out');
      const tableOut = document.getElementById('table-out');
      const paramsEl = document.getElementById('params');
      const tabText = document.getElementById('tab-text');
      const tabJson = document.getElementById('tab-json');
      const tabTable = document.getElementById('tab-table');
      const btnNlq = document.getElementById('btn-nlq');
      const btnRun = document.getElementById('btn-run');
      const btnTheme = document.getElementById('btn-theme');
      const exampleChips = Array.from(document.querySelectorAll('.chip'));
      let lastGraph = { nodes: [], links: [], meta: {} };
      let lastParams = {};
      let lastRaw = null;
      let lastTable = null;
      let resultView = 'text';

      function cssVar(name) {
        return getComputedStyle(document.body).getPropertyValue(name).trim();
      }

      function updateChartTheme() {
        const bg = cssVar('--bg');
        chart.setOption({ backgroundColor: bg });
        if (lastGraph.nodes && lastGraph.nodes.length) {
          renderGraph(lastGraph);
        }
      }

      function renderGraph(graph) {
        lastGraph = graph || { nodes: [], links: [], meta: {} };
        const text = cssVar('--text');
        const muted = cssVar('--muted');
        const border = cssVar('--border');
        const palette = ['#2b7fff','#34d399','#f59e0b','#ef4444','#a78bfa','#14b8a6','#e879f9','#60a5fa'];
        chart.setOption({
          backgroundColor: cssVar('--bg'),
          tooltip: {},
          color: palette,
          legend: [{ data: (graph.categories||[]).map(c=>c.name) }],
          series: [{
            type: 'graph',
            layout: 'force',
            roam: true,
            data: graph.nodes || [],
            links: graph.links || [],
            categories: graph.categories || (graph.meta && graph.meta.categories) || [],
            label: { show: true, position: 'right', color: text, fontSize: 12 },
            force: { repulsion: 140, edgeLength: 90 },
            lineStyle: { color: muted, opacity: .8 },
            itemStyle: { borderColor: border, borderWidth: 1 },
            emphasis: { focus: 'adjacency', lineStyle: { width: 2 } }
          }]
        });
      }

      function setLoading(loading) {
        [btnNlq, btnRun].forEach(btn => {
          if (!btn) return;
          btn.disabled = loading;
          btn.classList.toggle('loading', loading);
        });
      }

      function showError(message, data) {
        const payload = data ? { error: message, detail: data } : { error: message };
        if (resultView === 'text') {
          textOut.textContent = JSON.stringify(payload, null, 2);
        } else {
          jsonOut.textContent = JSON.stringify(payload, null, 2);
        }
      }

      function setResultView(view) {
        resultView = view;
        const isText = view === 'text';
        const isJson = view === 'json';
        const isTable = view === 'table';
        tabText.setAttribute('aria-selected', String(isText));
        tabJson.setAttribute('aria-selected', String(isJson));
        tabTable.setAttribute('aria-selected', String(isTable));
        textOut.style.display = isText ? 'block' : 'none';
        jsonOut.style.display = isJson ? 'block' : 'none';
        tableOut.style.display = isTable ? 'block' : 'none';
        renderResult();
      }

      function fmtVal(v) {
        if (v === null || v === undefined) return 'null';
        if (typeof v === 'string') return JSON.stringify(v);
        if (typeof v === 'number' || typeof v === 'boolean') return String(v);
        if (Array.isArray(v)) return '[' + v.map(fmtVal).join(', ') + ']';
        return JSON.stringify(v);
      }

      function nodeText(n) {
        const labels = n.labels && n.labels.length ? ':' + n.labels.join(':') : '';
        const props = n.properties || {};
        const pairs = Object.keys(props).map(k => `${k}: ${fmtVal(props[k])}`).join(', ');
        return `(${labels} {${pairs}})`;
      }

      function relText(r, dir) {
        const t = r.type || 'REL';
        const props = r.properties || {};
        const pairs = Object.keys(props).map(k => `${k}: ${fmtVal(props[k])}`).join(', ');
        const body = `[:${t}${pairs ? ' {' + pairs + '}' : ''}]`;
        return dir === 'in' ? `<-${body}-` : `-${body}->`;
      }

      function pathToText(p) {
        // p.kind === 'path' from normalized raw
        const nodes = (p.nodes || []).map(nodeText);
        const rels = (p.relationships || []).map((r) => relText(r, 'out'));
        let s = '';
        for (let i = 0; i < Math.max(nodes.length, rels.length); i++) {
          if (nodes[i]) s += nodes[i];
          if (rels[i]) s += rels[i];
        }
        return s;
      }

      function dictLooksLikeNode(d) {
        return d && typeof d === 'object' && (d.ID !== undefined || d.Id !== undefined || d.id !== undefined || d.Name !== undefined || d.name !== undefined);
      }

      function inferNodeFromDict(d) {
        const labels = [];
        if (d.IsFollowMe !== undefined) labels.push('recipe');
        if (d.MineTool !== undefined || d.ToolLevel !== undefined) labels.push('block');
        if (!labels.length) labels.push('item');
        return { labels, properties: d };
      }

      function listSequenceToText(arr) {
        // e.g. [nodeDict, 'REL', nodeDict, 'REL', nodeDict]
        let s = '';
        let lastNode = null;
        for (let i = 0; i < arr.length; i++) {
          const it = arr[i];
          if (Array.isArray(it)) { s += listSequenceToText(it); continue; }
          if (it && typeof it === 'object') {
            const n = dictLooksLikeNode(it) ? inferNodeFromDict(it) : { labels: [], properties: it };
            s += nodeText(n);
            lastNode = n;
            continue;
          }
          if (typeof it === 'string' && i + 1 < arr.length && dictLooksLikeNode(arr[i+1]) && lastNode) {
            s += relText({ type: it, properties: {} }, 'out');
            const n2 = inferNodeFromDict(arr[i+1]);
            s += nodeText(n2);
            i += 1;
            lastNode = n2;
            continue;
          }
          // fallback
          s += fmtVal(it);
        }
        return s;
      }

      function buildPrettyLines(raw) {
        if (!raw) return ['<æ— åŸå§‹æ•°æ®ï¼›è¯·å‹¾é€‰åŸå§‹æ•°æ®(raw)åå†æ‰§è¡Œ>'];
        const lines = [];
        for (const rec of raw) {
          for (const k of Object.keys(rec)) {
            const v = rec[k];
            if (v && v.kind === 'path') {
              lines.push(pathToText(v));
            } else if (Array.isArray(v)) {
              lines.push(listSequenceToText(v));
            } else if (v && v.kind === 'node') {
              lines.push(nodeText(v));
            } else if (v && v.kind === 'relationship') {
              lines.push(relText(v, 'out'));
            } else if (v && typeof v === 'object') {
              // maybe dict node
              if (dictLooksLikeNode(v)) lines.push(nodeText(inferNodeFromDict(v)));
              else lines.push(JSON.stringify(v));
            } else {
              lines.push(fmtVal(v));
            }
          }
        }
        return lines;
      }

      function renderResult() {
        if (resultView === 'text') {
          const lines = buildPrettyLines(lastRaw);
          textOut.textContent = lines.join('\n');
        } else if (resultView === 'json') {
          jsonOut.textContent = JSON.stringify(lastGraph, null, 2);
        } else {
          // è¡¨æ ¼è§†å›¾
          tableOut.innerHTML = '';
          const table = lastTable;
          if (!table || !table.columns) { tableOut.textContent = 'ï¼ˆæ— è¡¨æ ¼æ•°æ®ï¼‰'; return; }
          const el = document.createElement('table');
          el.style.borderCollapse = 'collapse';
          el.style.width = '100%';
          const th = document.createElement('tr');
          for (const c of table.columns) {
            const td = document.createElement('th');
            td.textContent = c;
            td.style.border = '1px solid #e5e7eb';
            td.style.padding = '6px 8px';
            td.style.textAlign = 'left';
            th.appendChild(td);
          }
          el.appendChild(th);
          for (const row of (table.rows || [])) {
            const tr = document.createElement('tr');
            for (const cell of row) {
              const td = document.createElement('td');
              td.textContent = (typeof cell === 'object') ? JSON.stringify(cell) : String(cell);
              td.style.border = '1px solid #e5e7eb';
              td.style.padding = '6px 8px';
              tr.appendChild(td);
            }
            el.appendChild(tr);
          }
          tableOut.appendChild(el);
        }
      }

      async function callNlq() {
        const query = q.value.trim();
        if (!query) {
          q.focus();
          return;
        }
        setLoading(true);
        try {
          const resp = await fetch('/nlq', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query, options: { limit: 100, debug_raw: true } })
          });
          const data = await resp.json();
          if (!resp.ok) {
            showError('ç”Ÿæˆæˆ–æ‰§è¡Œå¤±è´¥', data);
            return;
          }
          cqlEl.value = data.cql || '';
          lastParams = data.params || {};
          if (paramsEl) paramsEl.value = JSON.stringify(lastParams, null, 2);
          lastRaw = data.raw || null;
          const meta = data.graph?.meta || {};
          lastGraph = data.graph || { nodes: [], links: [], meta };
          lastTable = data.table || null;
          renderResult();
          renderGraph(data.graph || { nodes: [], links: [] });
        } catch (e) {
          showError('ç½‘ç»œæˆ–æœåŠ¡å¼‚å¸¸', String(e));
        } finally {
          setLoading(false);
        }
      }

      async function runCql() {
        const cql = (cqlEl.value || '').trim();
        if (!cql) { cqlEl.focus(); return; }
        setLoading(true);
        try {
          let params = {};
          try {
            const txt = (paramsEl?.value || '').trim();
            params = txt ? JSON.parse(txt) : lastParams;
          } catch (e) {
            showError('Params JSON è§£æå¤±è´¥', String(e));
            setLoading(false);
            return;
          }
          const resp = await fetch('/run-cql', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cql, params, raw: true })
          });
          const data = await resp.json();
          if (!resp.ok) {
            showError('æ‰§è¡Œå¤±è´¥', data);
            return;
          }
          lastRaw = data.raw || null;
          const meta = data.graph?.meta || {};
          lastGraph = data.graph || { nodes: [], links: [], meta };
          lastTable = data.table || null;
          renderResult();
          renderGraph(data.graph || { nodes: [], links: [] });
        } catch (e) {
          showError('ç½‘ç»œæˆ–æœåŠ¡å¼‚å¸¸', String(e));
        } finally {
          setLoading(false);
        }
      }

      tabText.addEventListener('click', () => setResultView('text'));
      tabJson.addEventListener('click', () => setResultView('json'));
      tabTable.addEventListener('click', () => setResultView('table'));

      function applyTheme(theme) {
        const isDark = theme === 'dark';
        document.body.classList.toggle('dark', isDark);
        btnTheme.setAttribute('aria-pressed', String(isDark));
        btnTheme.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateChartTheme();
      }

      function initTheme() {
        const saved = localStorage.getItem('theme');
        if (saved) { applyTheme(saved); return; }
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(prefersDark ? 'dark' : 'light');
      }

      btnTheme.addEventListener('click', () => {
        const next = document.body.classList.contains('dark') ? 'light' : 'dark';
        applyTheme(next);
      });

      document.getElementById('btn-nlq').addEventListener('click', callNlq);
      document.getElementById('btn-run').addEventListener('click', runCql);

      q.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); callNlq(); }
      });
      cqlEl.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); runCql(); }
      });
      exampleChips.forEach(chip => chip.addEventListener('click', () => { q.value = chip.getAttribute('data-q') || ''; q.focus(); }));

      window.addEventListener('resize', () => chart.resize());
      initTheme();
    </script>
  </body>
  </html>


