<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Neo4j NL→CQL→ECharts</title>
    <style>
      :root {
        --bg: #f7f8fa;
        --text: #111;
        --muted: #656f7b;
        --panel: #ffffff;
        --border: #e5e7eb;
        --primary: #2b7fff;
        --primary-600: #1f5fcc;
        --ring: rgba(43, 127, 255, .25);
        --chip-bg: #eef4ff;
        --chip-text: #1f4b99;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #0b0f17;
          --text: #e6e6e6;
          --muted: #9aa4b2;
          --panel: #0f1623;
          --border: #1f2a3b;
          --chip-bg: #14203a;
          --chip-text: #b7c6ff;
        }
      }
      body.dark {
        --bg: #0b0f17;
        --text: #e6e6e6;
        --muted: #9aa4b2;
        --panel: #0f1623;
        --border: #1f2a3b;
        --chip-bg: #14203a;
        --chip-text: #b7c6ff;
      }
      * { box-sizing: border-box; }
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'PingFang SC', 'Microsoft YaHei', sans-serif; margin: 0; background: var(--bg); color: var(--text); }
      header { position: sticky; top: 0; z-index: 10; display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 12px 16px; background: var(--panel); color: var(--text); border-bottom: 1px solid var(--border); }
      header .brand { display: flex; flex-direction: column; line-height: 1.1; }
      header .brand .title { font-weight: 700; letter-spacing: .1px; }
      header .brand .subtitle { font-size: 12px; color: var(--muted); }
      header .actions { display: flex; gap: 8px; }
      .icon-btn { appearance: none; border: 1px solid var(--border); background: var(--panel); color: var(--text); padding: 6px 10px; border-radius: 8px; cursor: pointer; line-height: 1; }
      .icon-btn:hover { border-color: #c8d1e0; }
      .icon-btn:focus-visible { outline: 2px solid var(--ring); outline-offset: 2px; }

      .toolbar { display: flex; gap: 8px; padding: 12px 16px; align-items: center; backdrop-filter: saturate(150%); }
      .toolbar input { flex: 1; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--panel); color: var(--text); }
      .toolbar input::placeholder { color: var(--muted); }
      .toolbar button { padding: 10px 14px; border-radius: 10px; border: 1px solid var(--primary); background: var(--primary); color: #fff; cursor: pointer; }
      .toolbar button.secondary { background: transparent; color: var(--primary); }
      .toolbar button:disabled { opacity: .6; cursor: not-allowed; }
      .loading { position: relative; pointer-events: none; }
      .loading::after { content: ""; position: absolute; right: 10px; top: 50%; width: 14px; height: 14px; margin-top: -7px; border: 2px solid rgba(255,255,255,.6); border-top-color: transparent; border-radius: 50%; animation: spin .9s linear infinite; }
      .toolbar button.secondary.loading::after { border-color: var(--primary); border-top-color: transparent; }
      @keyframes spin { to { transform: rotate(360deg); } }

      .examples { display: flex; gap: 8px; padding: 0 16px 12px 16px; flex-wrap: wrap; }
      .chip { border: 1px solid transparent; background: var(--chip-bg); color: var(--chip-text); padding: 6px 10px; border-radius: 999px; cursor: pointer; }
      .chip:hover { filter: brightness(1.05); }

      .main { display: grid; grid-template-columns: 420px 1fr; gap: 8px; padding: 8px; height: calc(100vh - 120px); box-sizing: border-box; }
      @media (max-width: 920px) { .main { grid-template-columns: 1fr; height: auto; } #chart { height: 420px; } }
      .left { display: flex; flex-direction: column; gap: 8px; }
      .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 10px; overflow: auto; height: 100%; box-shadow: 0 1px 0 rgba(17,24,39,.03); }
      .panel pre { white-space: pre-wrap; word-break: break-word; color: var(--muted); }
      .panel strong { color: var(--text); }
      textarea { width: 100%; height: calc(100% - 24px); resize: vertical; background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; }
      textarea:focus-visible, .toolbar input:focus-visible { outline: 2px solid var(--ring); outline-offset: 2px; }
      #chart { width: 100%; height: 100%; border: 1px solid var(--border); border-radius: 10px; background: var(--panel); }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  </head>
  <body>
    <header>
      <div class="brand">
        <div class="title">Neo4j 自然语言查询</div>
        <div class="subtitle">NL → CQL → ECharts</div>
      </div>
      <div class="actions">
        <button id="btn-theme" class="icon-btn" aria-pressed="false" title="切换主题">🌙</button>
      </div>
    </header>
    <div class="toolbar">
      <input id="q" placeholder="输入自然语言查询，如：所有的孤儿节点（限制20条）" />
      <button id="btn-nlq">生成并执行</button>
      <button id="btn-run" class="secondary">执行 CQL</button>
    </div>
    <div class="examples">
      <button class="chip" data-q="所有的孤儿节点（限制20条）">所有的孤儿节点（限制20条）</button>
      <button class="chip" data-q="合成配方的原料和材料（限制20条）">合成配方的原料和材料（限制20条）</button>
      <button class="chip" data-q="ID为404的block的掉落物（DROPS关系）">ID为404的block的掉落物（DROPS关系）</button>
      <button class="chip" data-q="最近新增的 10 个节点">最近新增的 10 个节点</button>
    </div>
    <div class="main">
      <div class="left">
        <div class="panel" style="height: 40%">
          <div><strong>CQL</strong></div>
          <textarea id="cql" style="width: 100%; height: calc(100% - 24px);"></textarea>
        </div>
        <div class="panel" style="height: 60%">
          <div><strong>结果</strong></div>
          <pre id="result"></pre>
        </div>
      </div>
      <div id="chart"></div>
    </div>

    <script>
      const chartEl = document.getElementById('chart');
      let chart = echarts.init(chartEl);
      const q = document.getElementById('q');
      const cqlEl = document.getElementById('cql');
      const resultEl = document.getElementById('result');
      const btnNlq = document.getElementById('btn-nlq');
      const btnRun = document.getElementById('btn-run');
      const btnTheme = document.getElementById('btn-theme');
      const exampleChips = Array.from(document.querySelectorAll('.chip'));
      let lastGraph = { nodes: [], links: [], meta: {} };

      function cssVar(name) {
        return getComputedStyle(document.body).getPropertyValue(name).trim();
      }

      function updateChartTheme() {
        const bg = cssVar('--bg');
        chart.setOption({ backgroundColor: bg });
        if (lastGraph.nodes && lastGraph.nodes.length) {
          renderGraph(lastGraph);
        }
      }

      function renderGraph(graph) {
        lastGraph = graph || { nodes: [], links: [], meta: {} };
        const text = cssVar('--text');
        const muted = cssVar('--muted');
        const border = cssVar('--border');
        const palette = ['#2b7fff','#34d399','#f59e0b','#ef4444','#a78bfa','#14b8a6','#e879f9','#60a5fa'];
        chart.setOption({
          backgroundColor: cssVar('--bg'),
          tooltip: {},
          color: palette,
          legend: [{ data: (graph.categories||[]).map(c=>c.name) }],
          series: [{
            type: 'graph',
            layout: 'force',
            roam: true,
            data: graph.nodes || [],
            links: graph.links || [],
            categories: graph.categories || [],
            label: { show: true, position: 'right', color: text, fontSize: 12 },
            force: { repulsion: 140, edgeLength: 90 },
            lineStyle: { color: muted, opacity: .8 },
            itemStyle: { borderColor: border, borderWidth: 1 },
            emphasis: { focus: 'adjacency', lineStyle: { width: 2 } }
          }]
        });
      }

      function setLoading(loading) {
        [btnNlq, btnRun].forEach(btn => {
          if (!btn) return;
          btn.disabled = loading;
          btn.classList.toggle('loading', loading);
        });
      }

      function showError(message, data) {
        const payload = data ? { error: message, detail: data } : { error: message };
        resultEl.textContent = JSON.stringify(payload, null, 2);
      }

      async function callNlq() {
        const query = q.value.trim();
        if (!query) {
          q.focus();
          return;
        }
        setLoading(true);
        try {
          const resp = await fetch('/nlq', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query, options: { limit: 100 } })
          });
          const data = await resp.json();
          if (!resp.ok) {
            showError('生成或执行失败', data);
            return;
          }
          cqlEl.value = data.cql || '';
          resultEl.textContent = JSON.stringify(data.graph?.meta || {}, null, 2);
          renderGraph(data.graph || { nodes: [], links: [] });
        } catch (e) {
          showError('网络或服务异常', String(e));
        } finally {
          setLoading(false);
        }
      }

      async function runCql() {
        const cql = (cqlEl.value || '').trim();
        if (!cql) { cqlEl.focus(); return; }
        setLoading(true);
        try {
          const resp = await fetch('/run-cql', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cql, params: {} })
          });
          const data = await resp.json();
          if (!resp.ok) {
            showError('执行失败', data);
            return;
          }
          resultEl.textContent = JSON.stringify(data.graph?.meta || {}, null, 2);
          renderGraph(data.graph || { nodes: [], links: [] });
        } catch (e) {
          showError('网络或服务异常', String(e));
        } finally {
          setLoading(false);
        }
      }

      function applyTheme(theme) {
        const isDark = theme === 'dark';
        document.body.classList.toggle('dark', isDark);
        btnTheme.setAttribute('aria-pressed', String(isDark));
        btnTheme.textContent = isDark ? '☀️' : '🌙';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateChartTheme();
      }

      function initTheme() {
        const saved = localStorage.getItem('theme');
        if (saved) { applyTheme(saved); return; }
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(prefersDark ? 'dark' : 'light');
      }

      btnTheme.addEventListener('click', () => {
        const next = document.body.classList.contains('dark') ? 'light' : 'dark';
        applyTheme(next);
      });

      document.getElementById('btn-nlq').addEventListener('click', callNlq);
      document.getElementById('btn-run').addEventListener('click', runCql);

      q.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); callNlq(); }
      });
      cqlEl.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); runCql(); }
      });
      exampleChips.forEach(chip => chip.addEventListener('click', () => { q.value = chip.getAttribute('data-q') || ''; q.focus(); }));

      window.addEventListener('resize', () => chart.resize());
      initTheme();
    </script>
  </body>
  </html>


